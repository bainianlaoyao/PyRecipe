"""
菜谱构建器 - 提供流畅的API和操作符重载
"""

from __future__ import annotations
from typing import Any, Dict, List, Optional

from .核心组件 import (
    食材组件,
    数量类型,
    烹饪操作,
    切制,
    混合操作,
    煎炒,
    炖煮,
)
from .处理器 import 菜谱处理器


# ============================================================================
# 菜谱构建器 (Recipe Builder)
# ============================================================================

class 菜谱构建器:
    """
    菜谱构建器

    提供流畅的链式API，支持操作符重载
    """

    def __init__(self, 处理器: 菜谱处理器):
        self.处理器 = 处理器

    # ========================================================================
    # 基础方法
    # ========================================================================

    def 取食材(self, 名称: str, 数量: 数量类型) -> 食材组件:
        """
        获取食材

        参数:
            名称: 食材名称
            数量: 食材数量

        返回:
            食材组件
        """
        return self.处理器.取食材(名称, 数量)

    # ========================================================================
    # 操作符重载 - 支持菜[]语法
    # ========================================================================

    def __getitem__(self, 键: tuple[str, 数量类型]) -> 食材组件:
        """
        支持 菜["名称", 数量] 语法

        示例:
            菜["土豆", 克(500)]
            菜["洋葱", 个(1)]
        """
        if isinstance(键, tuple) and len(键) == 2:
            名称, 数量 = 键
            return self.取食材(名称, 数量)
        raise TypeError("键必须是 (名称, 数量) 元组")

    # ========================================================================
    # 处理方法
    # ========================================================================

    def 处理(
        self,
        组件: List[食材组件],
        操作: 烹饪操作,
        名称: str,
        **元数据
    ) -> 食材组件:
        """
        处理食材

        参数:
            组件: 食材组件列表
            操作: 烹饪操作
            名称: 处理后的名称
            **元数据: 额外元数据

        返回:
            处理后的食材组件
        """
        return self.处理器.处理(组件, 操作, 名称, **元数据)

    # ========================================================================
    # 便利方法
    # ========================================================================

    def 切(self, 组件: 食材组件, 方式: str, 新名称: Optional[str] = None) -> 食材组件:
        """
        切割操作

        参数:
            组件: 要切割的食材
            方式: 切割方式（如"块"、"丝"、"片"）
            新名称: 切割后的名称（可选）

        返回:
            切割后的食材组件
        """
        名称 = 新名称 or f"{组件.name}_切{方式}"
        return self.处理器.处理([组件], 切制.切(方式), 名称)

    def 混合(
        self,
        组件: List[食材组件],
        描述: str,
        名称: str
    ) -> 食材组件:
        """
        混合操作

        参数:
            组件: 要混合的食材列表
            描述: 混合描述
            名称: 混合后的名称

        返回:
            混合后的食材组件
        """
        return self.处理器.处理(组件, 混合操作.混合(描述), 名称)

    def 炒(
        self,
        组件: List[食材组件],
        时间_秒: int,
        描述: str = "",
        名称: str = "",
        用油: Optional[int] = None
    ) -> 食材组件:
        """
        炒操作

        参数:
            组件: 要炒的食材列表
            时间_秒: 炒的时间（秒）
            描述: 操作描述
            名称: 炒后的名称
            用油: 用油量（克）

        返回:
            炒后的食材组件
        """
        完整描述 = 描述
        if 用油:
            完整描述 = f"用{用油}克油，{描述}" if 描述 else f"用{用油}克油"

        完整名称 = 名称 or f"炒{组件[0].name if 组件 else '食材'}"
        return self.处理器.处理(组件, 煎炒.炒(时间_秒, 完整描述), 完整名称)

    def 炖(
        self,
        组件: List[食材组件],
        时间_秒: int,
        描述: str = "",
        名称: str = ""
    ) -> 食材组件:
        """
        炖操作

        参数:
            组件: 要炖的食材列表
            时间_秒: 炖的时间（秒）
            描述: 操作描述
            名称: 炖后的名称

        返回:
            炖后的食材组件
        """
        完整名称 = 名称 or f"炖{组件[0].name if 组件 else '食材'}"
        return self.处理器.处理(组件, 炖煮.炖(时间_秒, 描述), 完整名称)

    def 调味(
        self,
        组件: List[食材组件],
        调料列表: List[str],
        名称: str
    ) -> 食材组件:
        """
        调味操作

        参数:
            组件: 要调味的食材列表
            调料列表: 调料名称列表
            名称: 调味后的名称

        返回:
            调味后的食材组件
        """
        from .核心组件 import 调味 as 调味操作
        return self.处理器.处理(组件, 调味操作.加调料(调料列表), 名称)

    def 自定义(
        self,
        组件: List[食材组件],
        描述: str,
        名称: str,
        **元数据
    ) -> 食材组件:
        """
        自定义操作

        参数:
            组件: 食材组件列表
            描述: 操作描述
            名称: 操作后的名称
            **元数据: 额外元数据

        返回:
            处理后的食材组件
        """
        return self.处理器.处理(
            组件,
            烹饪操作.其他(描述, **元数据),
            名称,
            **元数据
        )

    def 组合(
        self,
        组件: List[食材组件],
        描述: str,
        名称: str
    ) -> 食材组件:
        """
        组合操作（如夹在一起）

        参数:
            组件: 要组合的食材列表
            描述: 组合描述
            名称: 组合后的名称

        返回:
            组合后的食材组件
        """
        return self.处理器.处理(
            组件,
            烹饪操作.其他(描述),
            名称
        )

    # ========================================================================
    # 链式调用支持
    # ========================================================================

    class 组件包装器:
        """
        组件包装器，支持链式调用
        """

        def __init__(self, 组件: 食材组件, 构建器: 菜谱构建器):
            self.组件 = 组件
            self.构建器 = 构建器

        def 切(self, 方式: str, 新名称: Optional[str] = None) -> "菜谱构建器.组件包装器":
            """切割"""
            新组件 = self.构建器.切(self.组件, 方式, 新名称)
            return 菜谱构建器.组件包装器(新组件, self.构建器)

        def 混合(
            self,
            其他组件: List[食材组件],
            描述: str,
            名称: str
        ) -> "菜谱构建器.组件包装器":
            """混合"""
            新组件 = self.构建器.混合([self.组件] + 其他组件, 描述, 名称)
            return 菜谱构建器.组件包装器(新组件, self.构建器)

        def 炒(
            self,
            时间_秒: int,
            描述: str = "",
            名称: str = "",
            用油: Optional[int] = None
        ) -> "菜谱构建器.组件包装器":
            """炒"""
            新组件 = self.构建器.炒([self.组件], 时间_秒, 描述, 名称, 用油)
            return 菜谱构建器.组件包装器(新组件, self.构建器)

        def 炖(
            self,
            时间_秒: int,
            描述: str = "",
            名称: str = ""
        ) -> "菜谱构建器.组件包装器":
            """炖"""
            新组件 = self.构建器.炖([self.组件], 时间_秒, 描述, 名称)
            return 菜谱构建器.组件包装器(新组件, self.构建器)

        def 命名(self, 新名称: str) -> 食材组件:
            """重命名并返回组件"""
            # 创建新组件
            return 食材组件(
                name=新名称,
                数量=self.组件.数量,
                子组件=list(self.组件.子组件),
                元数据=dict(self.组件.元数据),
                操作=self.组件.操作,
                是否基础食材=self.组件.是否基础食材
            )

        def __add__(self, other: "菜谱构建器.组件包装器") -> 食材组件:
            """支持 + 操作符"""
            if isinstance(other, 菜谱构建器.组件包装器):
                other = other.组件
            return self.组件 + other

        def __rshift__(self, 操作: 烹饪操作) -> 食材组件:
            """支持 >> 操作符"""
            return self.组件 >> 操作

        def __and__(self, other: "菜谱构建器.组件包装器") -> 食材组件:
            """支持 & 操作符"""
            if isinstance(other, 菜谱构建器.组件包装器):
                other = other.组件
            return self.组件 & other

        def 组件(self) -> 食材组件:
            """获取底层组件"""
            return self.组件

    def 包装(self, 组件: 食材组件) -> 组件包装器:
        """包装组件以支持链式调用"""
        return self.组件包装器(组件, self)
